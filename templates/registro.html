{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Ventas</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
  <link rel="alternate icon" href="{% static 'favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'css/tailwind-production.css' %}">
  <link rel="stylesheet" href="{% static 'css/scanner.css' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Dark theme variables */
    :root {
      --bg-primary: #111111;
      --bg-secondary: #000000;
      --bg-tertiary: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --border-color: #333333;
      --accent-blue: #00d4ff;
      --accent-green: #00ff88;
    }
    
    body {
      background-color: #000000;
      color: var(--text-primary);
    }
    
    .modern-button {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .modern-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
      border-color: var(--accent-blue);
      background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
    }
    
    .modern-button.primary {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #0099cc 100%);
      border-color: var(--accent-blue);
      color: #000000;
    }
    
    .modern-card {
      background: #0a0a0a;
      border: 2px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.1);
    }
    
    /* Fix input text colors for user typing */
    input, select {
      color: #f9fafb !important;
    }
    
    input::placeholder {
      color: #9ca3af !important;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-blue) !important;
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2) !important;
      color: #f9fafb !important;
    }
    
    select option {
      background-color: #1f2937;
      color: #f9fafb;
    }

    /* Tab Buttons Styling */
    .tab-button {
      transition: all 0.2s ease;
    }
    
    .tab-button:hover {
      border-color: var(--accent-blue) !important;
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%) !important;
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2) !important;
      transform: translateY(-1px) scale(1.02);
    }
    
    .tab-button-active {
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4) !important;
    }
    
    /* Mobile responsive fixes */
    @media (max-width: 768px) {
      .text-sm {
        font-size: 1rem !important;
      }
      
      .text-xs {
        font-size: 0.875rem !important;
      }
      
      .text-lg {
        font-size: 1.25rem !important;
      }
      
      .text-2xl {
        font-size: 1.75rem !important;
      }
      
      .p-3 {
        padding: 0.875rem !important;
      }
      
      .p-6 {
        padding: 1.25rem !important;
      }
      
      .mb-2 {
        margin-bottom: 0.75rem !important;
      }
      
      .mb-6 {
        margin-bottom: 1.25rem !important;
      }
      
      .modern-card {
        padding: 1rem !important;
        margin: 0.5rem !important;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Navigation -->
  <nav class="border-b shadow-sm" style="background-color: #111111; border-color: #333333;">
    <div class="max-w-full mx-auto px-4 py-1.5">
      <div class="flex items-center justify-between">
        <div class="text-lg font-bold text-primary">{{ business.name|default:"DulcePOS" }}</div>
        
        <div class="flex items-center space-x-2">
          <a href="/punto_de_venta/" class="text-secondary hover:text-blue-600 font-medium text-xs">‚Üê Volver al POS</a>
          <a href="/accounts/logout/" class="text-secondary hover:text-blue-600 font-medium text-xs">Salir</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Tabs Navigation -->
  <div class="border-b" style="background-color: #111111; border-color: #333333;">
    <div class="max-w-full mx-auto px-4 py-2">
      <div class="flex flex-wrap gap-2">
        <a href="/punto_de_venta/" class="tab-button px-4 py-2 rounded-lg font-medium text-sm transition-all hover:scale-105" style="background: var(--bg-secondary); border: 2px solid var(--border-color); color: var(--text-primary);">
          üè™ Punto de Venta
        </a>
        <a href="/inventario/" class="tab-button px-4 py-2 rounded-lg font-medium text-sm transition-all hover:scale-105" style="background: var(--bg-secondary); border: 2px solid var(--border-color); color: var(--text-primary);">
          üì¶ Inventario
        </a>
        <a href="/ventas/" class="tab-button-active px-4 py-2 rounded-lg font-semibold text-sm transition-all" style="background: linear-gradient(135deg, var(--accent-blue) 0%, #0099cc 100%); color: #000000;">
          üìä Registro
        </a>
        <a href="/caja/" class="tab-button px-4 py-2 rounded-lg font-medium text-sm transition-all hover:scale-105" style="background: var(--bg-secondary); border: 2px solid var(--border-color); color: var(--text-primary);">
          üí∞ Caja
        </a>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="modern-card p-6 mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold" style="color: var(--text-primary);">Registro de Ventas</h1>
        <div class="text-right">
          <div class="text-sm" style="color: var(--text-secondary);">Total del d√≠a</div>
          <div class="text-2xl font-bold" style="color: var(--accent-green);" id="total-dia">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="modern-card p-4 mb-6">
      <form id="filtro-form" class="flex flex-wrap items-end gap-3">
        <div class="flex-1 min-w-32">
          <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">D√≠a:</label>
          <input type="date" id="filtro-dia" class="w-full p-2 text-sm rounded" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);" />
        </div>
        <div class="flex-1 min-w-32">
          <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Mes:</label>
          <input type="month" id="filtro-mes" class="w-full p-2 text-sm rounded" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);" />
        </div>
        <div class="flex-1 min-w-24">
          <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">A√±o:</label>
          <input type="number" id="filtro-anio" class="w-full p-2 text-sm rounded" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);" placeholder="2025" min="2000" />
        </div>
        <div class="flex-1 min-w-48">
          <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Producto:</label>
          <div class="flex space-x-1">
            <input type="text" id="filtro-producto" class="flex-1 p-2 text-sm rounded" style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);" placeholder="C√≥digo o nombre" />
            <button type="button" onclick="openScanner('filtro-producto')"
                    class="modern-button flex items-center justify-center px-2 text-sm"
                    style="min-width: 36px;">
              üîç
            </button>
          </div>
        </div>
        <div>
          <button type="submit" class="modern-button primary px-4 py-2 text-sm">Filtrar</button>
        </div>
      </form>
    </div>

    <!-- Sales Table -->
    <div class="modern-card">
      <div class="p-4" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); border-radius: 16px 16px 0 0;">
        <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Historial de Ventas</h3>
      </div>
      <div class="overflow-auto" style="max-height: 70vh;">
        <table class="w-full text-sm text-left" id="tabla-ventas">
          <thead style="background: var(--bg-tertiary); color: var(--text-primary); border-bottom: 2px solid var(--border-color);" class="sticky top-0">
            <tr>
              <th class="p-3 font-medium">Producto</th>
              <th class="p-3 font-medium text-center">Cantidad</th>
              <th class="p-3 font-medium text-right">Precio Unitario</th>
              <th class="p-3 font-medium text-right">Total</th>
              <th class="p-3 font-medium text-center">C√≥digo</th>
              <th class="p-3 font-medium text-center">Stock</th>
            </tr>
          </thead>
          <tbody id="tabla-ventas-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const formFiltro = document.getElementById("filtro-form");
  const tabla = document.querySelector("#tabla-ventas-body");
  const totalDiaSpan = document.getElementById("total-dia");

  function formatearPesos(monto) {
    return new Intl.NumberFormat('es-MX', {
      style: 'currency',
      currency: 'MXN',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(monto);
  }

  async function cargarVentas(queryParams = "") {
    try {
      console.log('[DEBUG] Cargando ventas con queryParams:', queryParams);
      
      // Get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // Usar la nueva API unificada que incluye movimientos de inventario
      console.log('[DEBUG] Haciendo fetch a:', `/registro/completo/${queryParams}`);
      const res = await fetch(`/registro/completo/${queryParams}`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      console.log('[DEBUG] Response status:', res.status);
      console.log('[DEBUG] Response headers:', res.headers);
      
      if (!res.ok) {
        const errorText = await res.text();
        console.error('[DEBUG] Error response:', errorText);
        throw new Error(`Error ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();

      tabla.innerHTML = "";

      // Para el total del d√≠a, usaremos la nueva API de ventas original como fallback
      // TODO: Implementar c√°lculo de total del d√≠a en la nueva API
      if (data.total_del_dia !== undefined) {
        totalDiaSpan.textContent = formatearPesos(data.total_del_dia);
      }

      // Verificar si es vista jer√°rquica
      if (data.es_vista_jerarquica && data.grupos_jerarquicos) {
        renderizarVistaJerarquica(data.grupos_jerarquicos);
      } else if (data.actividades && data.actividades.length > 0) {
        data.actividades.forEach(actividad => {
          const fecha = new Date(actividad.fecha).toLocaleString('es-MX');

          if (actividad.tipo === 'venta') {
            // Renderizar venta
            const filaHeader = document.createElement("tr");
            filaHeader.style.background = "var(--bg-tertiary)";
            filaHeader.style.borderBottom = "1px solid var(--border-color)";
            filaHeader.innerHTML = `
              <td colspan="6" class="p-3 font-semibold" style="color: var(--accent-blue);">
                ${actividad.titulo} del ${fecha} - Total: ${formatearPesos(actividad.total)}
                - üë§ ${actividad.usuario} - üí≥ ${actividad.metodo_pago}
              </td>
            `;
            tabla.appendChild(filaHeader);

            // Productos de la venta
            actividad.productos.forEach(producto => {
              // Buscar movimiento de stock para este producto
              const movimiento = actividad.movimientos_stock ?
                actividad.movimientos_stock.find(mov => mov.producto === producto.nombre) : null;

              const stockInfo = movimiento ?
                `üì¶ ${movimiento.stock_anterior} ‚Üí ${movimiento.stock_nuevo}` : '‚è≥ Sin registro';

              const fila = document.createElement("tr");
              fila.style.borderBottom = "1px solid var(--border-color)";
              fila.style.transition = "background-color 0.2s ease";
              fila.onmouseenter = () => fila.style.background = "rgba(0, 212, 255, 0.05)";
              fila.onmouseleave = () => fila.style.background = "transparent";
              fila.innerHTML = `
                <td class="p-3" style="color: var(--text-primary);">${producto.nombre}</td>
                <td class="p-3 text-center" style="color: var(--text-primary);">${producto.cantidad}</td>
                <td class="p-3 text-right font-mono" style="color: var(--text-primary);">${formatearPesos(producto.precio_unitario)}</td>
                <td class="p-3 text-right font-semibold" style="color: var(--accent-blue);">${formatearPesos(producto.subtotal)}</td>
                <td class="p-3 text-sm text-center font-mono" style="color: var(--text-secondary);">-</td>
                <td class="p-3 text-sm font-mono text-center" style="color: var(--accent-green);">${stockInfo}</td>
              `;
              tabla.appendChild(fila);
            });

          } else if (actividad.tipo === 'movimiento_stock') {
            // Renderizar movimiento de inventario
            const filaHeader = document.createElement("tr");
            filaHeader.style.background = "linear-gradient(135deg, #2a5a2a 0%, #1a4a1a 100%)";
            filaHeader.style.borderBottom = "1px solid var(--border-color)";
            filaHeader.innerHTML = `
              <td colspan="6" class="p-3 font-semibold" style="color: #90EE90;">
                ${actividad.titulo} del ${fecha} - üë§ ${actividad.usuario}
                ${actividad.motivo ? `- üìù ${actividad.motivo}` : ''}
              </td>
            `;
            tabla.appendChild(filaHeader);

            // Detalle del movimiento de stock
            const cantidad_text = actividad.producto.cantidad_movida > 0 ?
              `+${actividad.producto.cantidad_movida}` :
              `${actividad.producto.cantidad_movida}`;

            const fila = document.createElement("tr");
            fila.style.borderBottom = "1px solid var(--border-color)";
            fila.style.background = "rgba(144, 238, 144, 0.05)";
            fila.innerHTML = `
              <td class="p-3" style="color: var(--text-primary);">${actividad.producto.nombre}</td>
              <td class="p-3 text-center font-bold" style="color: ${actividad.producto.cantidad_movida > 0 ? '#90EE90' : '#FF6B6B'};">${cantidad_text}</td>
              <td class="p-3 text-center" style="color: var(--text-secondary);">-</td>
              <td class="p-3 text-center" style="color: var(--text-secondary);">-</td>
              <td class="p-3 text-sm text-center font-mono" style="color: var(--text-secondary);">${actividad.producto.codigo}</td>
              <td class="p-3 text-sm font-mono text-center font-bold" style="color: var(--accent-green);">
                üì¶ ${actividad.producto.stock_anterior} ‚Üí ${actividad.producto.stock_nuevo}
              </td>
            `;
            tabla.appendChild(fila);
          }
        });
      } else {
        // No hay actividades
        const filaVacia = document.createElement("tr");
        filaVacia.innerHTML = `
          <td colspan="6" class="p-6 text-center" style="color: var(--text-secondary);">
            No hay actividades registradas en el per√≠odo seleccionado
          </td>
        `;
        tabla.appendChild(filaVacia);
      }

      // Resto del c√≥digo para compatibilidad con versi√≥n anterior
      if (false && data.es_agrupado) {
        // Vista agrupada (sin filtros)
        if (data.grupos && data.grupos.length > 0) {
          data.grupos.forEach(grupo => {
            // Header del grupo con total
            const grupoHeader = document.createElement("tr");
            grupoHeader.style.background = "linear-gradient(135deg, var(--accent-blue) 0%, #0099cc 100%)";
            grupoHeader.style.color = "#000000";
            grupoHeader.style.cursor = "pointer";
            grupoHeader.onclick = () => toggleGrupo(grupo.titulo);
            grupoHeader.innerHTML = `
              <td colspan="6" class="p-4 font-bold text-center">
                üìÖ ${grupo.titulo} - Total: ${formatearPesos(grupo.total_grupo)}
                <span id="toggle-${grupo.titulo.replace(/\s+/g, '-')}" style="float: right;">‚ñº</span>
              </td>
            `;
            tabla.appendChild(grupoHeader);

            // Container del grupo (inicialmente visible solo para "Hoy")
            const grupoContainer = document.createElement("tbody");
            grupoContainer.id = `grupo-${grupo.titulo.replace(/\s+/g, '-')}`;
            grupoContainer.style.display = grupo.titulo.includes('Hoy') ? 'table-row-group' : 'none';
            
            grupo.ventas.forEach(venta => {
              const fecha = new Date(venta.fecha_creacion).toLocaleString('es-MX');

              // Fila resumen de venta
              const filaHeader = document.createElement("tr");
              filaHeader.style.background = "var(--bg-tertiary)";
              filaHeader.style.borderBottom = "1px solid var(--border-color)";
              filaHeader.innerHTML = `
                <td colspan="6" class="p-3 font-semibold" style="color: var(--accent-blue);">
                  üí∞ Venta #${venta.folio || venta.id} del ${fecha} - Total: ${formatearPesos(venta.total)}
                  ${venta.usuario ? `- üë§ ${venta.usuario.nombre_completo}` : ''}
                  ${venta.metodo_pago ? `- üí≥ ${venta.metodo_pago}` : ''}
                </td>
              `;
              grupoContainer.appendChild(filaHeader);

              // Filas por producto
              venta.detalles.forEach((detalle, index) => {
                const fila = document.createElement("tr");
                fila.style.borderBottom = "1px solid var(--border-color)";
                fila.style.transition = "background-color 0.2s ease";
                fila.onmouseenter = () => fila.style.background = "rgba(0, 212, 255, 0.05)";
                fila.onmouseleave = () => fila.style.background = "transparent";

                // Buscar movimiento de stock para este producto
                const movimiento = venta.movimientos_stock ?
                  venta.movimientos_stock.find(mov => mov.producto === detalle.producto.nombre) : null;

                const stockInfo = movimiento ?
                  `üì¶ ${movimiento.stock_anterior} ‚Üí ${movimiento.stock_nuevo}` : '';

                // Detectar si es una venta antigua (sin movimientos de stock)
                const esVentaAntigua = !venta.movimientos_stock || venta.movimientos_stock.length === 0;
                const stockDisplay = stockInfo || (esVentaAntigua ? '‚è≥ Venta anterior' : 'üì¶ Sin datos');

                fila.innerHTML = `
                  <td class="p-3" style="color: var(--text-primary);">${detalle.producto.nombre}</td>
                  <td class="p-3 text-center" style="color: var(--text-primary);">${detalle.cantidad}</td>
                  <td class="p-3 text-right font-mono" style="color: var(--text-primary);">${formatearPesos(detalle.precio_unitario)}</td>
                  <td class="p-3 text-right font-semibold" style="color: var(--accent-blue);">${formatearPesos(detalle.cantidad * detalle.precio_unitario)}</td>
                  <td class="p-3 text-sm text-center font-mono" style="color: var(--text-secondary);">-</td>
                  <td class="p-3 text-sm font-mono text-center" style="color: var(--accent-green);">${stockDisplay}</td>
                `;
                grupoContainer.appendChild(fila);
              });
            });
            
            tabla.appendChild(grupoContainer);
          });
        } else {
          // No hay ventas
          const filaVacia = document.createElement("tr");
          filaVacia.innerHTML = `
            <td colspan="6" class="p-6 text-center" style="color: var(--text-secondary);">
              No hay ventas registradas
            </td>
          `;
          tabla.appendChild(filaVacia);
        }
      } else {
        // Vista con filtros espec√≠ficos
        const ventas = data.ventas || [];
        if (ventas.length > 0) {
          ventas.forEach(venta => {
            const fecha = new Date(venta.fecha).toLocaleString('es-MX');

            // Fila resumen de venta
            const filaHeader = document.createElement("tr");
            filaHeader.style.background = "var(--bg-tertiary)";
            filaHeader.style.borderBottom = "1px solid var(--border-color)";
            filaHeader.innerHTML = `
              <td colspan="6" class="p-3 font-semibold" style="color: var(--accent-blue);">
                üí∞ Venta #${venta.folio || venta.id} del ${fecha} - Total: ${formatearPesos(venta.total_venta)}
                ${venta.usuario ? `- üë§ ${venta.usuario.nombre_completo}` : ''}
                ${venta.metodo_pago ? `- üí≥ ${venta.metodo_pago}` : ''}
              </td>
            `;
            tabla.appendChild(filaHeader);

            // Filas por producto
            venta.productos.forEach(p => {
              const fila = document.createElement("tr");
              fila.style.borderBottom = "1px solid var(--border-color)";
              fila.style.transition = "background-color 0.2s ease";
              fila.onmouseenter = () => fila.style.background = "rgba(0, 212, 255, 0.05)";
              fila.onmouseleave = () => fila.style.background = "transparent";

              // Buscar movimiento de stock para este producto
              const movimiento = venta.movimientos_stock ?
                venta.movimientos_stock.find(mov => mov.producto === p.nombre_producto) : null;

              const stockInfo = movimiento ?
                `üì¶ ${movimiento.stock_anterior} ‚Üí ${movimiento.stock_nuevo}` : '';

              // Detectar si es una venta antigua (sin movimientos de stock)
              const esVentaAntigua = !venta.movimientos_stock || venta.movimientos_stock.length === 0;
              const stockDisplay = stockInfo || (esVentaAntigua ? '‚è≥ Venta anterior' : 'üì¶ Sin datos');

              fila.innerHTML = `
                <td class="p-3" style="color: var(--text-primary);">${p.nombre_producto}</td>
                <td class="p-3 text-center" style="color: var(--text-primary);">${p.cantidad_vendida}</td>
                <td class="p-3 text-right font-mono" style="color: var(--text-primary);">${formatearPesos(p.precio_unitario)}</td>
                <td class="p-3 text-right font-semibold" style="color: var(--accent-blue);">${formatearPesos(p.total)}</td>
                <td class="p-3 text-sm text-center font-mono" style="color: var(--text-secondary);">-</td>
                <td class="p-3 text-sm font-mono text-center" style="color: var(--accent-green);">${stockDisplay}</td>
              `;
              tabla.appendChild(fila);
            });
          });
        } else {
          // No sales found
          const filaVacia = document.createElement("tr");
          filaVacia.innerHTML = `
            <td colspan="6" class="p-6 text-center" style="color: var(--text-secondary);">
              No se encontraron ventas para los filtros seleccionados
            </td>
          `;
          tabla.appendChild(filaVacia);
        }
      }
    } catch (error) {
      console.error("Error al cargar ventas:", error);
      console.error("Detalles del error:", error.message);
      
      // More detailed error message
      let errorMessage = "Error al cargar las ventas.";
      if (error.message.includes("404")) {
        errorMessage = "API de ventas no encontrada. Verifique que est√© autenticado.";
      } else if (error.message.includes("401") || error.message.includes("403")) {
        errorMessage = "No tiene permisos para ver las ventas. Contacte al administrador.";
      } else if (error.message.includes("Failed to fetch")) {
        errorMessage = "Error de conexi√≥n. Verifique su conexi√≥n a internet.";
      }
      
      tabla.innerHTML = `
        <tr>
          <td colspan="6" class="p-6 text-center" style="color: #ef4444;">
            ${errorMessage}<br>
            <small style="color: var(--text-secondary);">Detalles: ${error.message}</small>
          </td>
        </tr>
      `;
      
      if (totalDiaSpan) {
        totalDiaSpan.textContent = "$0.00";
      }
    }
  }

  // Renderizar vista jer√°rquica con a√±os ‚Üí meses ‚Üí semanas ‚Üí d√≠as
  function renderizarVistaJerarquica(gruposAnios) {
    tabla.innerHTML = "";

    gruposAnios.forEach(anio => {
      // Header del a√±o
      const anioHeader = document.createElement("tr");
      anioHeader.style.background = "var(--bg-tertiary)";
      anioHeader.style.borderBottom = "1px solid var(--border-color)";
      anioHeader.style.cursor = "pointer";
      anioHeader.onclick = () => toggleGrupoJerarquico('anio', anio.titulo);
      anioHeader.innerHTML = `
        <td colspan="6" class="p-3 font-medium" style="color: var(--text-primary);">
          ${anio.titulo} - Total: ${formatearPesos(anio.total)}
          <span id="toggle-anio-${anio.titulo}" style="float: right;">‚ñº</span>
        </td>
      `;
      tabla.appendChild(anioHeader);

      // Container del a√±o
      const anioContainer = document.createElement("tbody");
      anioContainer.id = `grupo-anio-${anio.titulo}`;
      anioContainer.style.display = anio.titulo === new Date().getFullYear().toString() ? 'table-row-group' : 'none';

      anio.meses.forEach(mes => {
        // Header del mes
        const mesHeader = document.createElement("tr");
        mesHeader.style.background = "var(--bg-tertiary)";
        mesHeader.style.borderBottom = "1px solid var(--border-color)";
        mesHeader.style.cursor = "pointer";
        mesHeader.onclick = () => toggleGrupoJerarquico('mes', `${anio.titulo}-${mes.titulo}`);
        mesHeader.innerHTML = `
          <td colspan="6" class="p-3 font-medium" style="color: var(--text-primary);">
            ${mes.titulo} - Total: ${formatearPesos(mes.total)}
            <span id="toggle-mes-${anio.titulo}-${mes.titulo.replace(/\s+/g, '-')}" style="float: right;">‚ñº</span>
          </td>
        `;
        anioContainer.appendChild(mesHeader);

        // Container del mes
        const mesContainer = document.createElement("tbody");
        mesContainer.id = `grupo-mes-${anio.titulo}-${mes.titulo.replace(/\s+/g, '-')}`;
        // Mostrar si es el mes actual y el a√±o actual
        const esAnioActual = anio.titulo === new Date().getFullYear().toString();
        const esMesActual = esAnioActual && mes.semanas.some(semana =>
          semana.dias.some(dia => dia.es_hoy)
        );
        mesContainer.style.display = esMesActual ? 'table-row-group' : 'none';

        mes.semanas.forEach(semana => {
          // Header de la semana
          const semanaHeader = document.createElement("tr");
          semanaHeader.style.background = "var(--bg-tertiary)";
          semanaHeader.style.borderBottom = "1px solid var(--border-color)";
          semanaHeader.style.cursor = "pointer";
          semanaHeader.onclick = () => toggleGrupoJerarquico('semana', `${anio.titulo}-${mes.titulo}-${semana.titulo}`);
          semanaHeader.innerHTML = `
            <td colspan="6" class="p-3 font-medium" style="color: var(--text-primary);">
              ${semana.titulo} - Total: ${formatearPesos(semana.total)}
              <span id="toggle-semana-${anio.titulo}-${mes.titulo.replace(/\s+/g, '-')}-${semana.titulo.replace(/\s+/g, '-')}" style="float: right;">‚ñº</span>
            </td>
          `;
          mesContainer.appendChild(semanaHeader);

          // Container de la semana
          const semanaContainer = document.createElement("tbody");
          semanaContainer.id = `grupo-semana-${anio.titulo}-${mes.titulo.replace(/\s+/g, '-')}-${semana.titulo.replace(/\s+/g, '-')}`;
          // Mostrar si es la semana actual
          const esSemanaActual = esMesActual && semana.dias.some(dia => dia.es_hoy);
          semanaContainer.style.display = esSemanaActual ? 'table-row-group' : 'none';

          semana.dias.forEach(dia => {
            // Header del d√≠a
            const diaHeader = document.createElement("tr");
            diaHeader.style.background = "var(--bg-tertiary)";
            diaHeader.style.borderBottom = "1px solid var(--border-color)";
            diaHeader.style.cursor = "pointer";
            diaHeader.onclick = () => toggleGrupoJerarquico('dia', `${anio.titulo}-${mes.titulo}-${semana.titulo}-${dia.titulo}`);
            diaHeader.innerHTML = `
              <td colspan="6" class="p-3 font-medium" style="color: var(--text-primary);">
                ${dia.titulo} - Total: ${formatearPesos(dia.total)}${dia.es_hoy ? ' (HOY)' : ''}
                <span id="toggle-dia-${dia.fecha.replace(/-/g, '')}" style="float: right;">‚ñº</span>
              </td>
            `;
            semanaContainer.appendChild(diaHeader);

            // Container del d√≠a
            const diaContainer = document.createElement("tbody");
            diaContainer.id = `grupo-dia-${dia.fecha.replace(/-/g, '')}`;
            diaContainer.style.display = dia.es_hoy ? 'table-row-group' : 'none';

            // Actividades del d√≠a
            dia.actividades.forEach(actividad => {
              if (actividad.tipo === 'venta') {
                // Agregar productos de la venta
                actividad.productos.forEach(producto => {
                  const movimiento = actividad.movimientos_stock ?
                    actividad.movimientos_stock.find(mov => mov.producto === producto.nombre) : null;

                  const stockInfo = movimiento ?
                    `üì¶ ${movimiento.stock_anterior} ‚Üí ${movimiento.stock_nuevo}` : '‚è≥ Sin registro';

                  const fila = document.createElement("tr");
                  fila.style.borderBottom = "1px solid var(--border-color)";
                  fila.style.transition = "background-color 0.2s ease";
                  fila.onmouseenter = () => fila.style.background = "rgba(0, 212, 255, 0.05)";
                  fila.onmouseleave = () => fila.style.background = "transparent";
                  fila.innerHTML = `
                    <td class="p-2 text-sm" style="color: var(--text-primary);">${producto.nombre}</td>
                    <td class="p-2 text-center text-sm" style="color: var(--text-primary);">${producto.cantidad}</td>
                    <td class="p-2 text-right font-mono text-sm" style="color: var(--text-primary);">${formatearPesos(producto.precio_unitario)}</td>
                    <td class="p-2 text-right font-semibold text-sm" style="color: var(--accent-blue);">${formatearPesos(producto.subtotal)}</td>
                    <td class="p-2 text-xs text-center" style="color: var(--text-secondary);">${actividad.usuario}</td>
                    <td class="p-2 text-xs font-mono text-center" style="color: var(--accent-green);">${stockInfo}</td>
                  `;
                  diaContainer.appendChild(fila);
                });
              } else if (actividad.tipo === 'movimiento_stock') {
                const cantidad_text = actividad.producto.cantidad_movida > 0 ?
                  `+${actividad.producto.cantidad_movida}` :
                  `${actividad.producto.cantidad_movida}`;

                const fila = document.createElement("tr");
                fila.style.borderBottom = "1px solid var(--border-color)";
                fila.style.background = "rgba(144, 238, 144, 0.05)";
                fila.innerHTML = `
                  <td class="p-2 text-sm" style="color: var(--text-primary);">${actividad.producto.nombre}</td>
                  <td class="p-2 text-center font-bold text-sm" style="color: ${actividad.producto.cantidad_movida > 0 ? '#90EE90' : '#FF6B6B'};">${cantidad_text}</td>
                  <td class="p-2 text-center text-sm" style="color: var(--text-secondary);">-</td>
                  <td class="p-2 text-center text-sm" style="color: var(--text-secondary);">-</td>
                  <td class="p-2 text-xs text-center" style="color: var(--text-secondary);">${actividad.usuario}</td>
                  <td class="p-2 text-xs font-mono text-center font-bold" style="color: var(--accent-green);">
                    ${actividad.producto.stock_anterior} ‚Üí ${actividad.producto.stock_nuevo}
                  </td>
                `;
                diaContainer.appendChild(fila);
              }
            });

            semanaContainer.appendChild(diaContainer);
          });

          mesContainer.appendChild(semanaContainer);
        });

        anioContainer.appendChild(mesContainer);
      });

      tabla.appendChild(anioContainer);
    });
  }

  // Toggle grupos jer√°rquicos
  function toggleGrupoJerarquico(tipo, identificador) {
    let grupoId, toggleId, simboloAbierto, simboloCerrado;

    switch(tipo) {
      case 'anio':
        grupoId = `grupo-anio-${identificador}`;
        toggleId = `toggle-anio-${identificador}`;
        simboloAbierto = '‚ñ≤';
        simboloCerrado = '‚ñº';
        break;
      case 'mes':
        const [anio, mes] = identificador.split('-', 2);
        grupoId = `grupo-mes-${anio}-${mes.replace(/\s+/g, '-')}`;
        toggleId = `toggle-mes-${anio}-${mes.replace(/\s+/g, '-')}`;
        simboloAbierto = '‚ñ≤';
        simboloCerrado = '‚ñº';
        break;
      case 'semana':
        const partes = identificador.split('-');
        grupoId = `grupo-semana-${partes.join('-').replace(/\s+/g, '-')}`;
        toggleId = `toggle-semana-${partes.join('-').replace(/\s+/g, '-')}`;
        simboloAbierto = '‚ñ≤';
        simboloCerrado = '‚ñº';
        break;
      case 'dia':
        const [a, m, s, d] = identificador.split('-');
        grupoId = `grupo-dia-${d.replace(/-/g, '')}`;
        toggleId = `toggle-dia-${d.replace(/-/g, '')}`;
        simboloAbierto = '‚ñ≤';
        simboloCerrado = '‚ñº';
        break;
    }

    const grupo = document.getElementById(grupoId);
    const toggle = document.getElementById(toggleId);

    if (grupo && toggle) {
      if (grupo.style.display === 'none') {
        grupo.style.display = 'table-row-group';
        toggle.textContent = simboloAbierto;
      } else {
        grupo.style.display = 'none';
        toggle.textContent = simboloCerrado;
      }
    }
  }

  // Load sales on page load
  document.addEventListener('DOMContentLoaded', function() {
    cargarVentas();
  });

  // Handle filter form submission
  formFiltro.addEventListener("submit", e => {
    e.preventDefault();

    const dia = document.getElementById("filtro-dia").value;
    const mes = document.getElementById("filtro-mes").value;
    const anio = document.getElementById("filtro-anio").value;
    const producto = document.getElementById("filtro-producto").value;

    const params = new URLSearchParams();
    if (dia) params.append("dia", dia);
    if (mes) params.append("mes", mes);
    if (anio) params.append("anio", anio);
    if (producto) params.append("producto", producto);

    const queryString = params.toString();
    cargarVentas(queryString ? "?" + queryString : "");
  });

  // Toggle grupos (expandir/colapsar)
  function toggleGrupo(titulo) {
    const grupoId = `grupo-${titulo.replace(/\s+/g, '-')}`;
    const toggleId = `toggle-${titulo.replace(/\s+/g, '-')}`;
    
    const grupo = document.getElementById(grupoId);
    const toggle = document.getElementById(toggleId);
    
    if (grupo && toggle) {
      if (grupo.style.display === 'none') {
        grupo.style.display = 'table-row-group';
        toggle.textContent = '‚ñº';
      } else {
        grupo.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }
  }

  // Make toggleGrupo globally available
  window.toggleGrupo = toggleGrupo;

  // Function to open scanner for product filter
  function openScanner(targetFieldId = null) {
    console.log(`üöÄ REGISTRO DEBUG: openScanner called with targetFieldId: ${targetFieldId}`);

    if (typeof BarCodeScanner !== 'undefined') {
      console.log(`‚úÖ REGISTRO DEBUG: BarCodeScanner available, opening with target: ${targetFieldId}`);
      BarCodeScanner.open(targetFieldId);
    } else {
      console.error(`‚ùå REGISTRO DEBUG: BarCodeScanner not available!`);
      alert('Scanner no disponible. Ingresa el c√≥digo manualmente.');
    }
  }

  // Make openScanner globally available
  window.openScanner = openScanner;
</script>

<!-- Include barcode scanner -->
<script src="{% static 'js/barcode-scanner.js' %}"></script>

</body>
</html>
