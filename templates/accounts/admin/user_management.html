{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - {{ business.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/scanner.css' %}">
</head>
<body class="bg-gray-100">
    
    <!-- Header -->
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">👥 Gestión de Usuarios</h1>
                <p class="text-blue-100">{{ business.name }}</p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/accounts/admin/create-user/" 
                   class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                    ➕ Agregar Usuario
                </a>
                <a href="/punto_de_venta/" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100">
                    ← Volver al POS
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Usuarios</p>
                        <p class="text-3xl font-bold text-gray-800">{{ users_data|length }}</p>
                    </div>
                    <div class="text-blue-500 text-2xl">👤</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Usuarios Activos</p>
                        <p class="text-3xl font-bold text-green-600">
                            {% for user_data in users_data %}{% if user_data.user.is_active %}1{% endif %}{% endfor %}0
                        </p>
                    </div>
                    <div class="text-green-500 text-2xl">✅</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Propietarios</p>
                        <p class="text-3xl font-bold text-purple-600">
                            {% for user_data in users_data %}{% if user_data.user.is_business_owner %}1{% endif %}{% endfor %}0
                        </p>
                    </div>
                    <div class="text-purple-500 text-2xl">👑</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Límite Plan</p>
                        <p class="text-3xl font-bold text-orange-600">{{ business.max_concurrent_users }}</p>
                    </div>
                    <div class="text-orange-500 text-2xl">📊</div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Lista de Usuarios</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Permisos Principales</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Último Acceso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for user_data in users_data %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium">
                                            {{ user_data.user.first_name|default:user_data.user.username|slice:":1"|upper }}
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ user_data.user.get_full_name|default:user_data.user.username }}
                                            {% if user_data.is_current_user %}
                                                <span class="text-blue-500 text-xs">(Tú)</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">{{ user_data.user.email }}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="px-6 py-4">
                                {% if user_data.user.is_business_owner %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                        👑 Propietario
                                    </span>
                                {% else %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                        👤 Empleado
                                    </span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <div class="flex flex-wrap gap-1">
                                    {% if user_data.permissions.can_access_pos %}
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">POS</span>
                                    {% endif %}
                                    {% if user_data.permissions.can_access_inventory %}
                                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Inventario</span>
                                    {% endif %}
                                    {% if user_data.permissions.can_access_reports %}
                                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Reportes</span>
                                    {% endif %}
                                    {% if user_data.permissions.can_manage_users %}
                                        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Admin</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="px-6 py-4">
                                {% if user_data.user.is_active %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                        ✅ Activo
                                    </span>
                                {% else %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                        ❌ Inactivo
                                    </span>
                                {% endif %}
                            </td>
                            
                            <td class="px-6 py-4 text-sm text-gray-500">
                                {{ user_data.user.last_login|date:"d/m/Y H:i"|default:"Nunca" }}
                            </td>
                            
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-2">
                                    <a href="/accounts/admin/edit-permissions/{{ user_data.user.id }}/" 
                                       class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                        ⚙️ Editar
                                    </a>
                                    
                                    {% if not user_data.is_current_user %}
                                        <button onclick="toggleUserActive({{ user_data.user.id }})"
                                                class="text-yellow-600 hover:text-yellow-900 text-sm font-medium">
                                            {% if user_data.user.is_active %}🔒 Desactivar{% else %}🔓 Activar{% endif %}
                                        </button>
                                        
                                        {% if not user_data.user.is_business_owner %}
                                            <button onclick="deleteUser({{ user_data.user.id }}, '{{ user_data.user.username }}')"
                                                    class="text-red-600 hover:text-red-900 text-sm font-medium">
                                                🗑️ Eliminar
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No hay usuarios registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">🔧 Configuraciones</h3>
                <p class="text-gray-600 text-sm mb-4">Ajusta la configuración general del negocio</p>
                <a href="/accounts/admin/business-settings/" 
                   class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Ver Configuraciones
                </a>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">📊 Estadísticas</h3>
                <p class="text-gray-600 text-sm mb-4">Revisa el uso y actividad del sistema</p>
                <a href="/accounts/admin/dashboard/" 
                   class="inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Ver Dashboard
                </a>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">🔐 Seguridad</h3>
                <p class="text-gray-600 text-sm mb-4">Gestiona la seguridad y permisos</p>
                <button class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Revisar Seguridad
                </button>
            </div>
        </div>
    </main>

    <script>
        function toggleUserActive(userId) {
            if (!confirm('¿Estás seguro de cambiar el estado de este usuario?')) {
                return;
            }
            
            fetch(`/accounts/admin/toggle-user-active/${userId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cambiar estado del usuario');
            });
        }
        
        function deleteUser(userId, username) {
            if (!confirm(`¿Estás seguro de eliminar permanentemente al usuario "${username}"?`)) {
                return;
            }
            
            fetch(`/accounts/admin/delete-user/${userId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar usuario');
            });
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>