<!-- templates/base.html - Template base -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema POS{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-100 font-sans">
    {% if user.is_authenticated %}
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">{{ user.business.name }}</h1>
                <span class="text-blue-200">{{ user.get_full_name }}</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="{% url 'pos:index' %}" class="hover:text-blue-200">POS</a>
                <a href="{% url 'inventario:inventario' %}" class="hover:text-blue-200">Inventario</a>
                <a href="{% url 'ventas:ventas' %}" class="hover:text-blue-200">Ventas</a>
                <a href="{% url 'accounts:dashboard' %}" class="hover:text-blue-200">Dashboard</a>
                <a href="{% url 'accounts:logout' %}" class="hover:text-blue-200">Salir</a>
            </div>
        </div>
    </nav>
    {% endif %}

    <main>
        {% if messages %}
        <div class="container mx-auto mt-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <script src="{% static 'js/main.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>


<!-- templates/accounts/login.html -->
{% extends 'base.html' %}

{% block title %}Iniciar Sesión - Sistema POS{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Iniciar Sesión
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Sistema POS para tu negocio
            </p>
        </div>
        <form class="mt-8 space-y-6" method="post">
            {% csrf_token %}
            <div class="rounded-md shadow-sm -space-y-px">
                <div>
                    <label for="{{ form.username.id_for_label }}" class="sr-only">Usuario</label>
                    {{ form.username }}
                </div>
                <div class="mt-4">
                    <label for="{{ form.password.id_for_label }}" class="sr-only">Contraseña</label>
                    {{ form.password }}
                </div>
            </div>

            {% if form.errors %}
            <div class="text-red-600 text-sm">
                {{ form.errors }}
            </div>
            {% endif %}

            <div>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Iniciar Sesión
                </button>
            </div>

            <div class="text-center">
                <a href="{% url 'accounts:register' %}" class="text-blue-600 hover:text-blue-500">
                    ¿No tienes cuenta? Registra tu negocio
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}


<!-- templates/pos/index.html - Punto de venta principal -->
{% extends 'base.html' %}

{% block title %}Punto de Venta - {{ user.business.name }}{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
    <header class="bg-pink-600 text-white p-6 shadow rounded-lg mb-6">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold">{{ user.business.name }}</h1>
            <h2 class="text-2xl font-semibold">Punto de Venta</h2>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Tabla de productos -->
        <div class="lg:col-span-2 bg-white p-6 shadow rounded-xl">
            <h3 class="text-xl font-semibold mb-4">Productos en el carrito</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-gray-600 border-b-2">
                        <tr>
                            <th class="pb-2">Producto</th>
                            <th class="pb-2">Cantidad</th>
                            <th class="pb-2">Precio Unitario</th>
                            <th class="pb-2">Precio Total</th>
                            <th class="pb-2">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-productos"></tbody>
                </table>
            </div>

            <div class="flex justify-between mt-6 text-lg font-semibold border-t pt-4">
                <div>Total: <span class="text-pink-600" id="total">$0.00</span></div>
                <div>Cambio: <span class="text-pink-600" id="cambio">$0.00</span></div>
            </div>

            <div class="flex gap-4 mt-4">
                <button onclick="cobrar()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 flex-1">
                    Cobrar
                </button>
                <button onclick="limpiarCarrito()" class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700">
                    Limpiar
                </button>
            </div>
        </div>

        <!-- Panel de agregar productos -->
        <div class="bg-white p-6 shadow rounded-xl">
            <h3 class="text-xl font-semibold mb-4">Agregar Producto</h3>
            <form id="formulario-producto" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium mb-1">Código de barras:</label>
                    <input type="text" id="codigo" class="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500" 
                           placeholder="Escanea o escribe el código" autocomplete="off" autofocus />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nombre:</label>
                        <input type="text" id="nombre" class="w-full p-2 border rounded" readonly />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Precio:</label>
                        <input type="text" id="precio" class="w-full p-2 border rounded" readonly />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Stock:</label>
                        <input type="text" id="stock" class="w-full p-2 border rounded bg-gray-100" readonly />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad:</label>
                        <input type="number" id="cantidad" class="w-full p-2 border rounded" min="1" value="1" />
                    </div>
                </div>

                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
                    Agregar al carrito
                </button>
            </form>

            <!-- Total del día -->
            <div class="mt-6 p-4 bg-gray-50 rounded">
                <h4 class="font-semibold text-gray-700">Total del día</h4>
                <p class="text-2xl font-bold text-green-600" id="total-dia">$0.00</p>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let carritoLocal = [];
const formProducto = document.getElementById("formulario-producto");
const tabla = document.getElementById("tabla-productos");
const totalSpan = document.getElementById("total");
const cambioSpan = document.getElementById("cambio");

// Función de redondeo personalizado
function redondear(monto) {
    const parteEntera = Math.floor(monto);
    const centavos = monto - parteEntera;
    return centavos >= 0.5 ? parteEntera + 1 : parteEntera;
}

// Buscar producto por código
async function buscarProductoPorCodigo(codigo) {
    if (!codigo) return clearProductoInputs();
    
    try {
        const res = await fetch("{% url 'pos:producto_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ codigo })
        });
        
        if (res.ok) {
            const prod = await res.json();
            document.getElementById("nombre").value = prod.nombre;
            document.getElementById("precio").value = `$${prod.precio.toFixed(2)}`;
            document.getElementById("stock").value = prod.stock;
        } else {
            clearProductoInputs();
        }
    } catch (error) {
        console.error("Error buscando producto:", error);
        clearProductoInputs();
    }
}

function clearProductoInputs() {
    document.getElementById("nombre").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("stock").value = "";
}

// Event listeners
document.getElementById("codigo").addEventListener("input", e => {
    buscarProductoPorCodigo(e.target.value.trim());
});

document.getElementById("codigo").addEventListener("keydown", async e => {
    if (e.key === "Enter") {
        e.preventDefault();
        await agregarProductoRapido(e.target.value.trim());
        e.target.value = "";
    }
});

// Agregar producto rápido (Enter en código)
async function agregarProductoRapido(codigo) {
    if (!codigo) return;
    
    try {
        const res = await fetch("{% url 'pos:agregar_producto' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ codigo, cantidad: 1 })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            alert(data.error);
            return;
        }
        
        agregarAlCarrito(data);
        
    } catch (error) {
        console.error("Error agregando producto:", error);
        alert("Error al agregar producto");
    }
}

// Agregar al carrito local
function agregarAlCarrito(producto) {
    const existente = carritoLocal.findIndex(p => p.codigo === producto.codigo);
    
    if (existente !== -1) {
        carritoLocal[existente].cantidad += producto.cantidad;
        const nuevoTotal = carritoLocal[existente].cantidad * carritoLocal[existente].precio_unitario;
        carritoLocal[existente].precio_total = redondear(nuevoTotal);
    } else {
        carritoLocal.push({
            codigo: producto.codigo,
            nombre: producto.nombre,
            cantidad: producto.cantidad,
            precio_unitario: producto.precio_unitario,
            precio_total: producto.precio_total
        });
    }
    
    actualizarTabla();
}

// Actualizar tabla visual
function actualizarTabla() {
    tabla.innerHTML = "";
    let sumaTotal = 0;
    
    carritoLocal.forEach((item, index) => {
        sumaTotal += item.precio_total;
        
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td class="py-2">${item.nombre}</td>
            <td class="py-2">
                <input type="number" min="1" value="${item.cantidad}" 
                       class="w-16 p-1 border rounded text-center cantidad-input" 
                       data-index="${index}" />
            </td>
            <td class="py-2">$${item.precio_unitario.toFixed(2)}</td>
            <td class="py-2 precio-total">$${item.precio_total.toFixed(2)}</td>
            <td class="py-2">
                <button onclick="eliminarDelCarrito(${index})" 
                        class="text-red-600 hover:text-red-800">
                    Eliminar
                </button>
            </td>
        `;
        tabla.appendChild(fila);
    });
    
    totalSpan.textContent = `$${sumaTotal.toFixed(2)}`;
    cambioSpan.textContent = "$0.00";
    
    // Event listeners para cambio de cantidad
    document.querySelectorAll(".cantidad-input").forEach(input => {
        input.addEventListener("change", e => {
            const index = parseInt(e.target.dataset.index);
            let nuevaCantidad = parseInt(e.target.value);
            
            if (isNaN(nuevaCantidad) || nuevaCantidad <= 0) {
                nuevaCantidad = 1;
                e.target.value = 1;
            }
            
            const item = carritoLocal[index];
            item.cantidad = nuevaCantidad;
            item.precio_total = redondear(item.precio_unitario * nuevaCantidad);
            
            actualizarTabla();
        });
    });
}

// Eliminar del carrito
function eliminarDelCarrito(index) {
    carritoLocal.splice(index, 1);
    actualizarTabla();
}

// Limpiar carrito
function limpiarCarrito() {
    if (carritoLocal.length === 0) {
        alert("El carrito ya está vacío.");
        return;
    }
    if (confirm("¿Deseas vaciar el carrito?")) {
        carritoLocal = [];
        actualizarTabla();
    }
}

// Cobrar
async function cobrar() {
    if (carritoLocal.length === 0) {
        alert("Agrega productos antes de cobrar.");
        return;
    }
    
    let pago = prompt("Ingrese la cantidad pagada:");
    if (!pago) return;
    
    pago = parseFloat(pago);
    const total = carritoLocal.reduce((sum, item) => sum + item.precio_total, 0);
    
    if (isNaN(pago) || pago < total) {
        alert("El pago es insuficiente.");
        return;
    }
    
    const cambio = pago - total;
    cambioSpan.textContent = `$${cambio.toFixed(2)}`;
    
    // Registrar venta
    try {
        const productos = carritoLocal.map(p => ({
            codigo: p.codigo,
            cantidad: p.cantidad
        }));
        
        const res = await fetch("{% url 'pos:registrar_venta' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ 
                productos,
                monto_pagado: pago
            })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            alert(`Venta registrada exitosamente. Cambio: $${cambio.toFixed(2)}`);
            carritoLocal = [];
            actualizarTabla();
            cambioSpan.textContent = "$0.00";
            cargarTotalDia();
        } else {
            alert("Error: " + (data.error || "No se pudo registrar la venta"));
        }
        
    } catch (error) {
        console.error("Error registrando venta:", error);
        alert("Error al registrar la venta");
    }
}

// Cargar total del día
async function cargarTotalDia() {
    try {
        const res = await fetch("{% url 'pos:total_hoy' %}");
        const data = await res.json();
        
        if (res.ok) {
            document.getElementById("total-dia").textContent = `$${data.total_hoy.toFixed(2)}`;
        }
    } catch (error) {
        console.error("Error cargando total del día:", error);
    }
}

// Submit form manual
formProducto.addEventListener("submit", async e => {
    e.preventDefault();
    
    const codigo = document.getElementById("codigo").value.trim();
    const cantidad = parseInt(document.getElementById("cantidad").value) || 1;
    
    if (!codigo) {
        alert("Ingresa un código de producto.");
        return;
    }
    
    try {
        const res = await fetch("{% url 'pos:agregar_producto' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ codigo, cantidad })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            agregarAlCarrito(data);
            formProducto.reset();
            document.getElementById("codigo").focus();
            clearProductoInputs();
        } else {
            alert(data.error);
        }
        
    } catch (error) {
        console.error("Error:", error);
        alert("Error al agregar producto");
    }
});

// Cargar total del día al iniciar
document.addEventListener("DOMContentLoaded", () => {
    cargarTotalDia();
    document.getElementById("codigo").focus();
});
</script>
{% endblock %}