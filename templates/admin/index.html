{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/custom/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Panel de Control</h1>
        <p class="dashboard-subtitle">Vista general del sistema</p>
    </div>

    <!-- Formulario Agregar Usuario (Owner o Employee) -->
    <div class="add-lead-section" style="margin-top: 30px;">
        <h2 style="margin-bottom: 20px; color: #1a202c;">Agregar Nuevo Usuario</h2>
        <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <form id="addLeadForm" method="post" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                {% csrf_token %}

                <!-- Tipo de Usuario -->
                <div style="grid-column: span 2; padding: 12px; background: #f7fafc; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600; font-size: 14px;">Tipo de Usuario *</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="user_type" value="owner" id="typeOwner" required checked
                                   style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #4a5568; font-weight: 500; font-size: 14px;">Business Owner (Dueño)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="user_type" value="employee" id="typeEmployee" required
                                   style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #4a5568; font-weight: 500; font-size: 14px;">Employee (Empleado)</span>
                        </label>
                    </div>
                </div>

                <!-- Datos Básicos -->
                <div>
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Nombre Completo *</label>
                    <input type="text" name="full_name" id="fullName" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Email *</label>
                    <input type="email" name="email" id="email" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                </div>

                <!-- Username y Password -->
                <div>
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Nombre de Usuario *</label>
                    <input type="text" name="username" id="username" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Contraseña *</label>
                    <input type="password" name="password" id="password" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                </div>

                <!-- Campos solo para Owner -->
                <div id="ownerFields" style="grid-column: span 2; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Teléfono *</label>
                        <input type="tel" name="phone" id="phone"
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Ciudad</label>
                        <input type="text" name="city" id="city"
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Nombre del Negocio *</label>
                        <input type="text" name="business_name" id="businessName"
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>

                    <!-- Checkbox para usuario sin cobro -->
                    <div style="grid-column: span 2; padding: 12px; background: #f7fafc; border-radius: 6px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sinCobroCheckbox" name="sin_cobro"
                                   style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #4a5568; font-weight: 500; font-size: 14px;">Usuario sin cobro (sin vencimiento)</span>
                        </label>
                    </div>

                    <!-- Campos de pago -->
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Meses Contratados</label>
                        <input type="number" id="mesesContratados" name="meses_contratados" min="1" max="120"
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Monto Pagado ($)</label>
                        <input type="number" id="montoPagado" name="monto_pagado" min="0" step="0.01"
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>

                <!-- Campo solo para Employee -->
                <div id="employeeFields" style="grid-column: span 2; display: none;">
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px;">Seleccionar Negocio *</label>
                    <select name="business_id" id="businessSelect"
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                        <option value="">Cargando negocios...</option>
                    </select>
                </div>

                <div style="grid-column: span 2; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit"
                            style="padding: 10px 24px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 14px;">
                        Crear Usuario
                    </button>
                </div>
            </form>
            <div id="formMessage" style="margin-top: 16px; display: none; padding: 12px; border-radius: 6px;"></div>
        </div>
    </div>

    <!-- Usuarios Próximos a Vencer -->
    {% if usuarios_proximos_vencer %}
    <div class="expiring-users-section" style="margin-top: 40px;">
        <h2 style="margin-bottom: 20px; color: #1a202c;">Usuarios Próximos a Vencer</h2>

        <!-- Buscador -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchExpiring" placeholder="Buscar por nombre, email o negocio..."
                   style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
        </div>

        <table id="expiringTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Nombre</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Email</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Negocio</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Fecha Corte</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Días Restantes</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Monto</th>
                </tr>
            </thead>
            <tbody id="expiringTableBody">
                {% for usuario in usuarios_proximos_vencer %}
                <tr style="border-bottom: 1px solid #e2e8f0;"
                    data-name="{{ usuario.full_name|lower }}"
                    data-email="{{ usuario.email|lower }}"
                    data-business="{{ usuario.business.nombre|default:''|lower }}">
                    <td style="padding: 12px; color: #2d3748;">{{ usuario.full_name }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ usuario.email }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ usuario.business.nombre|default:"-" }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ usuario.fecha_corte|date:"d/m/Y" }}</td>
                    <td style="padding: 12px;">
                        <span style="padding: 4px 12px; background: {% if usuario.dias_restantes < 7 %}#fed7d7{% elif usuario.dias_restantes < 30 %}#fef3c7{% else %}#d1fae5{% endif %}; color: {% if usuario.dias_restantes < 7 %}#742a2a{% elif usuario.dias_restantes < 30 %}#78350f{% else %}#065f46{% endif %}; border-radius: 12px; font-size: 12px; font-weight: 500;">
                            {{ usuario.dias_restantes }} días
                        </span>
                    </td>
                    <td style="padding: 12px; color: #2d3748;">${{ usuario.monto_pagado|default:"0"|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Paginación -->
        <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 8px;">
            <!-- Se genera con JavaScript -->
        </div>
    </div>
    {% endif %}

    <!-- Últimos Leads -->
    <div class="leads-section" style="margin-top: 30px;">
        <h2 style="margin-bottom: 20px; color: #1a202c;">Últimos Leads</h2>
        {% if ultimos_usuarios %}
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Nombre</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Email</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Teléfono</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Ciudad</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Estado</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in ultimos_usuarios %}
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px; color: #2d3748;">{{ lead.full_name }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ lead.email }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ lead.phone }}</td>
                    <td style="padding: 12px; color: #2d3748;">{{ lead.city|default:"-" }}</td>
                    <td style="padding: 12px;">
                        <span style="padding: 4px 12px; background: #edf2f7; color: #4a5568; border-radius: 12px; font-size: 12px; font-weight: 500;">
                            {{ lead.get_status_display }}
                        </span>
                    </td>
                    <td style="padding: 12px; color: #718096; font-size: 14px;">{{ lead.created_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 15px; text-align: right;">
            <a href="{% url 'admin:pos_userregistration_changelist' %}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                Ver todos los leads →
            </a>
        </div>
        {% else %}
        <p style="padding: 20px; background: #f7fafc; border-radius: 8px; color: #718096;">No hay leads registrados aún.</p>
        {% endif %}
    </div>

    <script>
    // ========================================
    // PAGINACIÓN Y BÚSQUEDA DE USUARIOS PRÓXIMOS A VENCER
    // ========================================
    const rowsPerPage = 20;
    let currentPage = 1;
    let allRows = [];
    let filteredRows = [];

    function initializeExpiringTable() {
        const tableBody = document.getElementById('expiringTableBody');
        if (!tableBody) return;

        allRows = Array.from(tableBody.querySelectorAll('tr'));
        filteredRows = allRows;
        showPage(1);
    }

    function showPage(page) {
        currentPage = page;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // Ocultar todas las filas
        allRows.forEach(row => row.style.display = 'none');

        // Mostrar solo las filas de la página actual
        filteredRows.slice(start, end).forEach(row => row.style.display = '');

        // Actualizar paginación
        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        const paginationDiv = document.getElementById('pagination');
        if (!paginationDiv) return;

        let html = '';

        // Botón anterior
        if (currentPage > 1) {
            html += `<button onclick="showPage(${currentPage - 1})" style="padding: 8px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; color: #4a5568;">← Anterior</button>`;
        }

        // Números de página
        for (let i = 1; i <= totalPages; i++) {
            if (
                i === 1 ||
                i === totalPages ||
                (i >= currentPage - 2 && i <= currentPage + 2)
            ) {
                const isActive = i === currentPage;
                html += `<button onclick="showPage(${i})" style="padding: 8px 12px; border: 1px solid #e2e8f0; background: ${isActive ? '#667eea' : 'white'}; color: ${isActive ? 'white' : '#4a5568'}; border-radius: 6px; cursor: pointer; font-weight: ${isActive ? '600' : '500'};">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += `<span style="padding: 8px;">...</span>`;
            }
        }

        // Botón siguiente
        if (currentPage < totalPages) {
            html += `<button onclick="showPage(${currentPage + 1})" style="padding: 8px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; color: #4a5568;">Siguiente →</button>`;
        }

        paginationDiv.innerHTML = html;
    }

    // Búsqueda
    const searchInput = document.getElementById('searchExpiring');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            filteredRows = allRows.filter(row => {
                const name = row.dataset.name || '';
                const email = row.dataset.email || '';
                const business = row.dataset.business || '';

                return name.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       business.includes(searchTerm);
            });

            showPage(1);
        });
    }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', initializeExpiringTable);

    // ========================================
    // FORMULARIO AGREGAR USUARIO
    // ========================================
    const typeOwner = document.getElementById('typeOwner');
    const typeEmployee = document.getElementById('typeEmployee');
    const ownerFields = document.getElementById('ownerFields');
    const employeeFields = document.getElementById('employeeFields');
    const phoneInput = document.getElementById('phone');
    const businessNameInput = document.getElementById('businessName');
    const businessSelect = document.getElementById('businessSelect');
    const sinCobroCheckbox = document.getElementById('sinCobroCheckbox');
    const mesesInput = document.getElementById('mesesContratados');
    const montoInput = document.getElementById('montoPagado');

    // Cargar lista de negocios al inicio
    async function loadBusinesses() {
        try {
            const response = await fetch('{% url "admin:get_businesses" %}');
            const data = await response.json();

            if (data.success) {
                businessSelect.innerHTML = '<option value="">-- Seleccionar negocio --</option>';
                data.businesses.forEach(business => {
                    const option = document.createElement('option');
                    option.value = business.id;
                    option.textContent = business.name;
                    businessSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error cargando negocios:', error);
            businessSelect.innerHTML = '<option value="">Error cargando negocios</option>';
        }
    }

    // Llamar al cargar la página
    loadBusinesses();

    // Manejar cambio de tipo de usuario
    function toggleUserTypeFields() {
        if (typeOwner.checked) {
            ownerFields.style.display = 'grid';
            employeeFields.style.display = 'none';
            phoneInput.required = true;
            businessNameInput.required = true;
            businessSelect.required = false;
        } else {
            ownerFields.style.display = 'none';
            employeeFields.style.display = 'block';
            phoneInput.required = false;
            businessNameInput.required = false;
            businessSelect.required = true;
        }
    }

    typeOwner.addEventListener('change', toggleUserTypeFields);
    typeEmployee.addEventListener('change', toggleUserTypeFields);

    // Manejar checkbox de "sin cobro"
    sinCobroCheckbox.addEventListener('change', function() {
        if (this.checked) {
            mesesInput.disabled = true;
            montoInput.disabled = true;
            mesesInput.value = '';
            montoInput.value = '';
            mesesInput.style.background = '#f7fafc';
            montoInput.style.background = '#f7fafc';
        } else {
            mesesInput.disabled = false;
            montoInput.disabled = false;
            mesesInput.style.background = 'white';
            montoInput.style.background = 'white';
        }
    });

    document.getElementById('addLeadForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const messageDiv = document.getElementById('formMessage');

        // Limpiar teléfono (solo números)
        const phoneInput = document.getElementById('phone');
        if (phoneInput && phoneInput.value) {
            const cleanPhone = phoneInput.value.replace(/\D/g, '');
            formData.set('phone', cleanPhone);
        }

        // Si el checkbox está marcado, eliminar los campos de pago del FormData
        if (sinCobroCheckbox.checked) {
            formData.delete('meses_contratados');
            formData.delete('monto_pagado');
        }

        try {
            const response = await fetch('{% url "admin:add_lead_manual" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#c6f6d5';
                messageDiv.style.color = '#22543d';
                messageDiv.textContent = data.message;
                this.reset();
                sinCobroCheckbox.checked = false;
                mesesInput.disabled = false;
                montoInput.disabled = false;
                mesesInput.style.background = 'white';
                montoInput.style.background = 'white';

                // Recargar después de 1.5 segundos
                setTimeout(() => location.reload(), 1500);
            } else {
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fed7d7';
                messageDiv.style.color = '#742a2a';
                messageDiv.textContent = data.error || 'Error al agregar el lead';
            }
        } catch (error) {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#fed7d7';
            messageDiv.style.color = '#742a2a';
            messageDiv.textContent = 'Error de conexión. Intenta nuevamente.';
        }
    });
    </script>
</div>
{% endblock %}
