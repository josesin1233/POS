<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ user.business.name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <header class="bg-pink-600 text-white p-6 shadow">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold">{{ user.business.name }}</h1>
      <h2 class="text-2xl font-semibold">Venta</h2>
    </div>
  </header>

  <nav class="bg-white shadow p-4 flex gap-6 justify-center text-gray-700 font-medium">
    <a href="inventario" class="hover:text-pink-600">Inventario</a>
    <a href="/ventas/" class="hover:text-pink-600">Registro</a>
    <a href="Caja" class="hover:text-pink-600">Caja</a>
    <a href="/Cerrar" class="hover:text-pink-600">Cerrar</a>
  </nav>

  <main class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-7xl mx-auto">
    
    <section class="md:col-span-2 bg-white p-4 shadow rounded-xl">
      <table class="w-full text-sm text-left">
        <thead class="text-gray-600 border-b-2">
          <tr>
            <th class="pb-2">Producto</th>
            <th class="pb-2">Cantidad</th>
            <th class="pb-2">Precio Unitario</th>
            <th class="pb-2">Precio Total</th>
          </tr>
        </thead>
        <tbody id="tabla-productos"></tbody>
      </table>

      <div class="flex justify-between mt-6 text-lg font-semibold">
        <div>Total: <span class="text-pink-600" id="total">$0.00</span></div>
        <div>Cambio: <span class="text-pink-600" id="cambio">$0.00</span></div>
      </div>
    </section>

    <aside class="bg-white p-4 shadow rounded-xl max-w-md">
      <h3 class="text-xl font-semibold mb-4">Agregar producto manualmente</h3>
      <form id="formulario-producto" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">CÃ³digo:</label>
            <input type="text" id="codigo" class="w-full p-2 border rounded" autocomplete="off" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Nombre:</label>
            <input type="text" id="nombre" class="w-full p-2 border rounded" autocomplete="off" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Precio:</label>
            <input type="text" id="precio" class="w-full p-2 border rounded" readonly />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Stock:</label>
            <input type="text" id="stock" class="w-full p-2 border rounded bg-gray-100" disabled />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium mb-1">Cantidad:</label>
            <input type="number" id="cantidad" class="w-full p-2 border rounded" min="1" />
          </div>
          <button type="submit" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700 w-full h-[42px]">
            Agregar
          </button>
        </div>
      </form>
<button onclick="cobrar()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full mt-4">
  Cobrar
</button>

<button id="btn-limpiar" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 w-full mt-2">
  Limpiar carrito
</button>

    </aside>
  </main>

  <script>
    const formProducto = document.getElementById("formulario-producto");
    const tabla = document.getElementById("tabla-productos");
    const totalSpan = document.getElementById("total");
    const cambioSpan = document.getElementById("cambio");
    let carritoLocal = [];

    async function buscarProductoPorCodigo(codigo) {
      if (!codigo) return clearProductoInputs();
      const res = await fetch("/producto", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ codigo })
      });
      if (res.ok) {
        const prod = await res.json();
        if (prod.nombre) {
          document.getElementById("nombre").value = prod.nombre;
          document.getElementById("precio").value = prod.precio;
          document.getElementById("stock").value = prod.stock;
        } else {
          clearProductoInputs();
        }
      } else {
        clearProductoInputs();
      }
    }

    async function buscarProductoPorNombre(nombre) {
      if (!nombre) return clearProductoInputs();
      const res = await fetch("/producto", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre })
      });
      if (res.ok) {
        const prod = await res.json();
        if (prod.codigo) {
          document.getElementById("codigo").value = prod.codigo;
          document.getElementById("precio").value = prod.precio;
          document.getElementById("stock").value = prod.stock;
        } else {
          clearProductoInputs();
        }
      } else {
        clearProductoInputs();
      }
    }

    function clearProductoInputs() {
      document.getElementById("precio").value = "";
      document.getElementById("stock").value = "";
    }

    document.getElementById("codigo").addEventListener("input", e => {
      buscarProductoPorCodigo(e.target.value.trim());
    });
    document.getElementById("codigo").addEventListener("keydown", async e => {
  if (e.key === "Enter") {
    e.preventDefault();

    const codigo = e.target.value.trim();
    if (!codigo) return;

    const res = await fetch("/agregar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ codigo, cantidad: 1 }) // Siempre 1 al escanear
    });

    const data = await res.json();

    if (!res.ok) {
      alert(data.error);
      return;
    }

    const indexExistente = carritoLocal.findIndex(p => p.codigo === data.codigo);
    if (indexExistente !== -1) {
      carritoLocal[indexExistente].cantidad += 1;
      const nuevoTotal = carritoLocal[indexExistente].cantidad * carritoLocal[indexExistente].precio_unitario;
      carritoLocal[indexExistente].precio_total = redondear(nuevoTotal);
    } else {
      carritoLocal.push({
        codigo: data.codigo,
        nombre: data.nombre,
        cantidad: 1,
        precio_unitario: data.precio_unitario,
        precio_total: data.precio_total
      });
    }

    actualizarTabla(carritoLocal);
    e.target.value = "";
  }
});

    document.getElementById("nombre").addEventListener("input", e => {
      buscarProductoPorNombre(e.target.value.trim());
    });

    function actualizarTabla(carrito) {
  tabla.innerHTML = "";
  let sumaTotal = 0;

  carrito.forEach((item, index) => {
    sumaTotal += item.precio_total;

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${item.nombre}</td>
      <td>
        <input type="number" min="1" value="${item.cantidad}" class="cantidad-input w-16 p-1 border rounded text-center" data-index="${index}" />
      </td>
      <td>$${item.precio_unitario.toFixed(2)}</td>
      <td class="precio-total">$${item.precio_total.toFixed(2)}</td>
    `;
    tabla.appendChild(fila);
  });

  totalSpan.textContent = `$${sumaTotal.toFixed(2)}`;
  cambioSpan.textContent = "$0.00";

  // ðŸ” Agregar evento a cada input de cantidad
  document.querySelectorAll(".cantidad-input").forEach(input => {
    input.addEventListener("change", e => {
      const index = parseInt(e.target.dataset.index);
      let nuevaCantidad = parseInt(e.target.value);

      if (isNaN(nuevaCantidad) || nuevaCantidad <= 0) {
        nuevaCantidad = 1;
        e.target.value = 1;
      }

      const item = carritoLocal[index];
      item.cantidad = nuevaCantidad;

      const nuevoTotal = item.precio_unitario * nuevaCantidad;
      item.precio_total = redondear(nuevoTotal);  // Redondear cada producto

      actualizarTabla(carritoLocal);
    });
  });
}


    formProducto.addEventListener("submit", async e => {
      e.preventDefault();

      const codigo = document.getElementById("codigo").value.trim();
      const cantidad = parseInt(document.getElementById("cantidad").value);

      if (!codigo || isNaN(cantidad) || cantidad <= 0) {
        alert("Completa todos los campos correctamente.");
        return;
      }

      const res = await fetch("/agregar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ codigo, cantidad })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error);
        return;
      }

      const producto = {
        codigo: data.codigo,
        nombre: data.nombre,
        cantidad: data.cantidad,
        precio_unitario: data.precio_unitario,
        precio_total: data.precio_total
      };
      carritoLocal.push(producto);
      actualizarTabla(carritoLocal);

      document.getElementById("codigo").value = "";
      document.getElementById("nombre").value = "";
      document.getElementById("precio").value = "";
      document.getElementById("stock").value = "";
      document.getElementById("cantidad").value = "";
      document.getElementById("codigo").focus();
    });

    async function cobrar() {
      if (carritoLocal.length === 0) {
        alert("Agrega productos antes de cobrar.");
        return;
      }

      let pago = prompt("Ingrese la cantidad pagada:");
      if (!pago) return;

      pago = parseFloat(pago);
      const total = carritoLocal.reduce((sum, item) => sum + item.precio_total, 0);

      if (isNaN(pago) || pago < total) {
        alert("El pago es insuficiente.");
        return;
      }

      const cambio = pago - total;
      cambioSpan.textContent = `$${cambio.toFixed(2)}`;
      alert(`Pago realizado con Ã©xito. Cambio: $${cambio.toFixed(2)}`);

      const productos = carritoLocal.map(p => ({
        codigo: p.codigo,
        cantidad: p.cantidad
      }));

      const res = await fetch("/ventas/registrar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productos })
      });

      const data = await res.json();
      if (!res.ok) {
        alert(data.error || "Error al registrar la venta");
        return;
      }

      carritoLocal = [];
      actualizarTabla(carritoLocal);
      cambioSpan.textContent = "$0.00";

    }
    document.getElementById("btn-limpiar").addEventListener("click", limpiarCarrito);

function limpiarCarrito() {
  if (carritoLocal.length === 0) {
    alert("El carrito ya estÃ¡ vacÃ­o.");
    return;
  }
  if (confirm("Â¿Deseas vaciar el carrito?")) {
    carritoLocal = [];
    actualizarTabla(carritoLocal);
    cambioSpan.textContent = "$0.00";
  }
}

function redondear(monto) {
  const parteEntera = Math.floor(monto);
  const centavos = monto - parteEntera;
  return centavos >= 0.5 ? parteEntera + 1 : parteEntera;
}

  </script>
</body>
</html>
