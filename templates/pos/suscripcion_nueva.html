<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suscribirse - POS M√âXICO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #6B46C1 0%, #9333EA 50%, #C026D3 100%);
        }
        .plan-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .plan-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        .plan-featured {
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .gradient-text {
            background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="min-h-screen text-white">

    <!-- Navigation Header -->
    <header class="bg-black/20 backdrop-blur-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <!-- Logo POS M√âXICO -->
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                        <span class="text-white font-bold text-xl">P</span>
                    </div>
                    <span class="text-2xl font-bold text-white">
                        POS M√âXICO
                    </span>
                </div>
                <div class="text-sm text-white/80">
                    Control total desde cualquier dispositivo con internet.
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <!-- Hero Section -->
        <div class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                Todo tu negocio al alcance de tu
                <span class="gradient-text">tel√©fono</span>
            </h1>
            <p class="text-lg text-white/80 max-w-2xl mx-auto leading-relaxed mb-8">
                (tus datos son privados y solo tu tienes acceso)
            </p>

            <!-- Important Notice -->
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 max-w-2xl mx-auto mb-12">
                <h3 class="text-xl font-semibold text-white mb-3">
                    üì¢ Aviso Importante
                </h3>
                <p class="text-white/90">
                    El pago desde la web no est√° disponible por el momento. Despu√©s de seleccionar tu plan,
                    te contactaremos para finalizar tu suscripci√≥n de forma segura.
                </p>
            </div>
        </div>

        <!-- Plans Section -->
        <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">

            <!-- Plan Est√°ndar -->
            <div class="plan-card bg-white/10 backdrop-blur-sm rounded-3xl p-8 relative">
                <!-- Plan Header -->
                <div class="text-center mb-6">
                    <div class="bg-white/20 rounded-full px-6 py-3 inline-block mb-4">
                        <span class="text-white font-semibold text-lg">Est√°ndar</span>
                    </div>
                    <div class="text-center mb-6">
                        <span class="text-6xl font-bold text-white">$149</span>
                        <span class="text-white/80 text-xl">/mes</span>
                    </div>
                    <div class="bg-yellow-400 text-purple-900 px-4 py-2 rounded-full text-sm font-semibold mb-6">
                        POR TIEMPO LIMITADO
                    </div>
                </div>

                <!-- Features -->
                <div class="space-y-4 mb-8">
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Esc√°ner de barras desde la c√°mara de cualquier dispositivo</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Cada vez que vendes algo, el sistema descuenta el producto, actualiza tu inventario y lleva el control del dinero que entra.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">El programa te dice qu√© productos tienen poco stock.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">F√°cil de usar, listo para usar en un d√≠a.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Hasta dos Usuarios simult√°neos sin jerarqu√≠a.</span>
                    </div>
                </div>

                <!-- CTA Button -->
                <button
                    onclick="selectPlan('estandar', 149)"
                    class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 border border-white/30 hover:border-white/50"
                >
                    Seleccionar - $149/mes
                </button>
            </div>

            <!-- Plan Pro -->
            <div class="plan-card plan-featured bg-white/15 backdrop-blur-sm rounded-3xl p-8 relative">
                <!-- Plan Header -->
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full px-6 py-3 inline-block mb-4">
                        <span class="text-purple-900 font-semibold text-lg">Pro</span>
                    </div>
                    <div class="text-center mb-6">
                        <span class="text-6xl font-bold text-white">$249</span>
                        <span class="text-white/80 text-xl">/mes</span>
                    </div>
                </div>

                <!-- Features -->
                <div class="space-y-4 mb-8">
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm font-semibold">TODAS las caracter√≠sticas del plan est√°ndar</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Puedes escoger cu√°les usuarios pueden cambiar precios, eliminar productos, cerrar cajas, etc.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Genera tickets listos para enviar o imprimir.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Sistema de reconocimiento de clientes para recompensas por puntos ganados en compras.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Atenci√≥n t√©cnica prioritaria.</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="text-green-400 font-bold">‚Ä¢</span>
                        <span class="text-white/90 text-sm">Hasta 4 usuarios simult√°neos</span>
                    </div>
                </div>

                <!-- CTA Button -->
                <button
                    onclick="selectPlan('pro', 249)"
                    class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-purple-900 font-bold py-4 px-6 rounded-2xl transition-all duration-300"
                >
                    Seleccionar - $249/mes
                </button>
            </div>
        </div>

        <!-- Additional Features -->
        <div class="text-center mt-16">
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 max-w-md mx-auto">
                <h3 class="text-xl font-semibold text-white mb-4">
                    Genera tickets y registra movimientos en tu inventario
                </h3>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-12">
            <p class="text-white/60 text-sm mb-4">
                RECLAMA TU PRUEBA GRATIS SIN CUENTA AQU√ç
            </p>
            <div class="flex items-center justify-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 border-2 border-white/30 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">üì∑</span>
                    </div>
                    <span class="text-white/80 text-sm">@POS.MEXICO</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Registration Modal -->
    <div id="registration-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Registro de Suscripci√≥n</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
                </div>

                <form id="registration-form" class="space-y-6">
                    <!-- Plan Selection Display -->
                    <div id="selected-plan-display" class="bg-purple-50 rounded-xl p-4">
                        <h3 class="font-semibold text-purple-800 mb-2">Plan Seleccionado</h3>
                        <div id="plan-details" class="text-purple-600"></div>
                    </div>

                    <!-- Privacy Notice -->
                    <div class="bg-blue-50 rounded-xl p-4">
                        <p class="text-blue-800 text-sm">
                            üîí <strong>Datos Privados:</strong> Toda tu informaci√≥n es completamente privada y segura. Solo t√∫ tienes acceso a tus datos.
                        </p>
                    </div>

                    <!-- Datos Usuario -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Datos Usuario</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario</label>
                                <input type="text" id="admin_username" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                                <input type="password" id="admin_password" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                <input type="text" id="admin_first_name" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
                                <input type="text" id="admin_last_name" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                                <input type="email" id="contact_email" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                <input type="tel" id="contact_phone" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Datos Negocio -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Datos Negocio</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Negocio</label>
                                <input type="text" id="business_name" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Negocio</label>
                                <select id="business_type" required
                                        class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">Selecciona...</option>
                                    <option value="tienda">Tienda</option>
                                    <option value="papeleria">Papeler√≠a</option>
                                    <option value="abarrotes">Abarrotes</option>
                                    <option value="farmacia">Farmacia</option>
                                    <option value="restaurant">Restaurante</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label>
                                <textarea id="address" required rows="3"
                                          class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                                <input type="text" id="state" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s</label>
                                <input type="text" id="country" value="M√©xico" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div id="payment-section" style="display: none;">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Informaci√≥n de Pago</h3>

                        <!-- Payment Element Container -->
                        <div id="payment-element" class="mb-4">
                            <!-- Stripe Payment Element will be mounted here -->
                        </div>

                        <!-- Payment Errors -->
                        <div id="payment-errors" role="alert" class="text-red-600 text-sm mb-4 hidden"></div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" id="submit-btn"
                                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-6 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300">
                            <span id="btn-text">Continuar con el Pago</span>
                            <span id="btn-loading" style="display: none;">Procesando...</span>
                        </button>
                        <p class="text-center text-sm text-gray-600 mt-3" id="submit-notice">
                            Haz clic para proceder con el pago seguro mediante Stripe.
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Stripe
        const stripe = Stripe('{{ stripe_publishable_key }}');
        let elements = null;
        let paymentElement = null;
        let clientSecret = null;
        let registrationId = null;

        let selectedPlan = null;
        let selectedPrice = 0;
        let currentStep = 'registration'; // 'registration' or 'payment'

        function selectPlan(planName, price) {
            selectedPlan = planName;
            selectedPrice = price;

            // Update modal content
            const planDetails = document.getElementById('plan-details');
            const planDisplayName = planName === 'estandar' ? 'Est√°ndar' : 'Pro';
            planDetails.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold">${planDisplayName}</span>
                    <span class="text-lg font-bold">$${price}/mes</span>
                </div>
            `;

            // Show modal
            document.getElementById('registration-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('registration-modal').classList.add('hidden');
        }

        async function initializePayment(clientSecret) {
            elements = stripe.elements({
                clientSecret: clientSecret,
                appearance: {
                    theme: 'stripe',
                    variables: {
                        colorPrimary: '#9333EA',
                        colorBackground: '#ffffff',
                        colorText: '#1f2937',
                        colorDanger: '#dc2626',
                        fontFamily: 'Poppins, sans-serif',
                        spacingUnit: '8px',
                        borderRadius: '12px'
                    }
                }
            });

            paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');

            paymentElement.on('ready', () => {
                console.log('Payment Element ready');
            });

            paymentElement.on('change', (event) => {
                const errorElement = document.getElementById('payment-errors');
                if (event.error) {
                    errorElement.textContent = event.error.message;
                    errorElement.classList.remove('hidden');
                } else {
                    errorElement.classList.add('hidden');
                }
            });
        }

        // Handle form submission
        document.getElementById('registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');

            try {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                submitBtn.disabled = true;

                if (currentStep === 'registration') {
                    // Step 1: Register user and get client secret
                    const formData = {
                        // Plan data
                        selected_plan: selectedPlan,
                        plan_price: selectedPrice,

                        // User data
                        admin_username: document.getElementById('admin_username').value,
                        admin_password: document.getElementById('admin_password').value,
                        admin_first_name: document.getElementById('admin_first_name').value,
                        admin_last_name: document.getElementById('admin_last_name').value,
                        contact_email: document.getElementById('contact_email').value,
                        contact_phone: document.getElementById('contact_phone').value,

                        // Business data
                        business_name: document.getElementById('business_name').value,
                        business_type: document.getElementById('business_type').value,
                        address: document.getElementById('address').value,
                        state: document.getElementById('state').value,
                        country: document.getElementById('country').value
                    };

                    // Register subscription
                    const registerResponse = await fetch('/api/suscripcion/registrar/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify(formData)
                    });

                    const registerResult = await registerResponse.json();

                    if (!registerResponse.ok) {
                        throw new Error(registerResult.error || 'Error al registrar');
                    }

                    registrationId = registerResult.registration_id;

                    // Get Stripe client secret
                    const paymentResponse = await fetch('/api/suscripcion/pago/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            registration_id: registrationId,
                            payment_method: 'stripe'
                        })
                    });

                    const paymentResult = await paymentResponse.json();

                    if (!paymentResponse.ok) {
                        throw new Error(paymentResult.error || 'Error al preparar pago');
                    }

                    clientSecret = paymentResult.client_secret;

                    // Initialize Payment Element
                    await initializePayment(clientSecret);

                    // Show payment section
                    document.getElementById('payment-section').style.display = 'block';
                    btnText.textContent = 'Completar Pago';
                    document.getElementById('submit-notice').textContent = 'Completa tu informaci√≥n de pago para activar tu suscripci√≥n.';
                    currentStep = 'payment';

                } else if (currentStep === 'payment') {
                    // Step 2: Confirm payment
                    const {error} = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            return_url: window.location.origin + '/suscripcion/confirmada/',
                        },
                    });

                    if (error) {
                        const errorElement = document.getElementById('payment-errors');
                        errorElement.textContent = error.message;
                        errorElement.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            } finally {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Get CSRF token
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        // Close modal on outside click
        document.getElementById('registration-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Check for preselected plan from URL
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedPlan = urlParams.get('plan');

            if (preselectedPlan) {
                // Map URL plan names to our internal names
                const planMapping = {
                    'estandar': 'Est√°ndar',
                    'intermedio': 'Intermedio',
                    'pro': 'Pro'
                };

                const planName = planMapping[preselectedPlan];
                if (planName) {
                    // Auto-select the plan
                    const planButtons = document.querySelectorAll('.plan-card');
                    planButtons.forEach(card => {
                        const title = card.querySelector('h3')?.textContent?.trim();
                        if (title === planName) {
                            // Remove previous selections
                            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
                            // Select this plan
                            card.classList.add('selected');
                            selectedPlan = planName;

                            // Update modal button text
                            document.getElementById('start-subscription').textContent = `Continuar con ${planName}`;

                            // Optional: Open modal automatically
                            // openModal();
                        }
                    });
                }
            }
        });
    </script>

    <!-- CSRF Token -->
    {% csrf_token %}

</body>
</html>