{% extends 'base_production.html' %}
{% load static %}

{% block title %}Suscripciones - DulcePOS{% endblock %}

{% block extra_css %}
<script src="https://js.stripe.com/v3/"></script>
<style>
    /* Subscription specific styles with dark theme */
    .subscription-container {
        background-color: var(--bg-secondary);
        min-height: 100vh;
    }

    .plan-card {
        background: #0a0a0a;
        border: 2px solid var(--border-color);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .plan-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
        border-color: var(--accent-blue);
    }

    .plan-card.selected {
        border-color: var(--accent-green);
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
    }

    .plan-featured {
        /* Removed "M√ÅS POPULAR" styling */
    }

    .btn-plan-select {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #0099cc 100%);
        border: 2px solid var(--accent-blue);
        color: #000000;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 12px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-plan-select:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
    }

    .btn-plan-select.selected {
        background: linear-gradient(135deg, var(--accent-green) 0%, #00cc66 100%);
        border-color: var(--accent-green);
    }

    .modern-input {
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .modern-input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .modern-input::placeholder {
        color: var(--text-secondary);
    }

    .registration-form {
        background: #0a0a0a;
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 32px;
    }

    .payment-form {
        background: #0a0a0a;
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 32px;
    }

    /* Stripe Payment Element styling */
    .StripeElement {
        background: var(--bg-tertiary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        padding: 12px !important;
    }

    .StripeElement--focus {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1) !important;
    }

    /* Navigation header styles */
    .nav-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border-bottom: 2px solid var(--border-color);
        padding: 16px 0;
    }

    .nav-brand {
        color: var(--accent-blue);
        font-weight: 700;
        font-size: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .nav-links a {
        color: var(--text-secondary);
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .nav-links a:hover {
        color: var(--accent-blue);
        background: rgba(0, 212, 255, 0.1);
    }

    /* Form animation */
    .form-container {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.5s ease;
    }

    .form-container.show {
        max-height: 2000px;
        opacity: 1;
        margin-top: 48px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Header -->
<div class="nav-header">
    <div class="container mx-auto px-6">
        <div class="flex justify-between items-center">
            <div class="nav-brand">
                DulcePOS
            </div>
            <div class="nav-links flex space-x-4">
                <a href="/punto_de_venta/">üè™ POS</a>
                <a href="/inventario/">üì¶ Inventario</a>
                <a href="/caja/">üí∞ Caja</a>
                <a href="/registro/">üìä Registro</a>
                <a href="/accounts/login/">üîê Login</a>
            </div>
        </div>
    </div>
</div>

<div class="subscription-container">
    <div class="container mx-auto px-6 py-12">

        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4" style="color: var(--text-primary);">
                Elige tu Plan de Suscripci√≥n
            </h1>
            <p class="text-xl" style="color: var(--text-secondary);">
                Selecciona el plan que mejor se adapte a tu negocio
            </p>
        </div>

        <!-- Plans Section -->
        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto mb-12">

            <!-- Plan Est√°ndar -->
            <div class="plan-card" id="plan-estandar">
                <div class="p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-2xl"
                             style="background: linear-gradient(135deg, var(--accent-blue), #0099cc);">
                            üè™
                        </div>
                        <h3 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">Est√°ndar</h3>
                        <div class="text-4xl font-bold mb-2" style="color: var(--accent-blue);">$299</div>
                        <div style="color: var(--text-secondary);">/mes</div>
                    </div>

                    <ul class="space-y-3 mb-8">
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> 1 usuario
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> 500 productos
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Sistema POS completo
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Control de inventario
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Reportes b√°sicos
                        </li>
                    </ul>

                    <button onclick="selectPlan('estandar', 299)" class="btn-plan-select w-full">
                        Seleccionar Plan
                    </button>
                </div>
            </div>

            <!-- Plan Pro -->
            <div class="plan-card" id="plan-pro">
                <div class="p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-2xl"
                             style="background: linear-gradient(135deg, var(--accent-green), #00cc66);">
                            üöÄ
                        </div>
                        <h3 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">Pro</h3>
                        <div class="text-4xl font-bold mb-2" style="color: var(--accent-green);">$499</div>
                        <div style="color: var(--text-secondary);">/mes</div>
                    </div>

                    <ul class="space-y-3 mb-8">
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Todo del plan Est√°ndar
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Hasta 5 usuarios
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Productos ilimitados
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Reportes avanzados
                        </li>
                        <li class="flex items-center" style="color: var(--text-primary);">
                            <span style="color: var(--accent-green);" class="mr-3">‚úì</span> Multi-sucursal
                        </li>
                    </ul>

                    <button onclick="selectPlan('pro', 499)" class="btn-plan-select w-full">
                        Seleccionar Plan
                    </button>
                </div>
            </div>
        </div>

        <!-- User Info + Payment Form (initially hidden) -->
        <div class="max-w-2xl mx-auto form-container" id="payment-section">
            <div class="payment-form">
                <h3 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
                    Informaci√≥n de Usuario y Pago
                </h3>

                <div id="plan-summary" class="mb-6 p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-color);">
                    <!-- Plan summary will be inserted here -->
                </div>

                <!-- User Info Form -->
                <form id="payment-form">
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Nombre *
                            </label>
                            <input type="text" name="admin_first_name" id="user-name" required
                                   class="modern-input w-full" placeholder="Juan">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Apellido *
                            </label>
                            <input type="text" name="admin_last_name" required
                                   class="modern-input w-full" placeholder="P√©rez">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Email *
                            </label>
                            <input type="email" name="contact_email" id="user-email" required
                                   class="modern-input w-full" placeholder="juan@gmail.com">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Tel√©fono *
                            </label>
                            <input type="tel" name="contact_phone" id="user-phone" required
                                   class="modern-input w-full" placeholder="5551234567">
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <h4 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
                        Informaci√≥n de Pago
                    </h4>

                    <div id="payment-element" class="mb-6">
                        <!-- Stripe Payment Element will be inserted here -->
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="goBackToPlans()"
                                class="flex-1 py-4 px-6 rounded-lg font-semibold border-2"
                                style="background: transparent; border-color: var(--border-color); color: var(--text-primary);">
                            ‚Üê Cambiar Plan
                        </button>
                        <button type="submit" id="submit-payment"
                                class="flex-1 btn-plan-select py-4">
                            <span id="button-text">Pagar Ahora</span>
                            <div id="spinner" class="hidden">Procesando...</div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Business Info Form (shown after successful payment) -->
        <div class="max-w-2xl mx-auto hidden" id="business-section">
            <div class="registration-form">
                <h3 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
                    ¬°Pago Exitoso! Completa la informaci√≥n de tu negocio
                </h3>

                <form id="business-form">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Nombre del Negocio *
                            </label>
                            <input type="text" name="business_name" id="business-name" required
                                   class="modern-input w-full" placeholder="Mi Dulcer√≠a">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Tipo de Negocio *
                            </label>
                            <select name="business_type" id="business-type" required class="modern-input w-full">
                                <option value="">Selecciona...</option>
                                <option value="Dulcer√≠a">Dulcer√≠a</option>
                                <option value="Tienda de Abarrotes">Tienda de Abarrotes</option>
                                <option value="Farmacia">Farmacia</option>
                                <option value="Papeler√≠a">Papeler√≠a</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Usuario (Login) *
                            </label>
                            <input type="text" name="admin_username" required
                                   class="modern-input w-full" placeholder="juan123">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Contrase√±a *
                            </label>
                            <input type="password" name="admin_password" required
                                   class="modern-input w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Direcci√≥n *
                            </label>
                            <textarea name="address" id="address" required
                                      class="modern-input w-full" rows="2"
                                      placeholder="Calle Principal #123, Colonia Centro"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Ciudad *
                            </label>
                            <input type="text" name="city" id="city" required
                                   class="modern-input w-full" placeholder="Ciudad de M√©xico">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                Estado *
                            </label>
                            <input type="text" name="state" id="state" required
                                   class="modern-input w-full" placeholder="CDMX">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                C√≥digo Postal *
                            </label>
                            <input type="text" name="postal_code" id="postal-code" required
                                   class="modern-input w-full" placeholder="01000">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                                RFC (Opcional)
                            </label>
                            <input type="text" name="rfc" id="rfc"
                                   class="modern-input w-full" placeholder="XAXX010101000">
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button type="submit" id="submit-business" class="btn-plan-select px-12 py-4">
                            <span>Completar Registro</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
    // Global variables - initialize properly
    var selectedPlan = null;
    var selectedPrice = 0;
    var currentStep = 'registration';
    var stripe = null;
    var elements = null;
    var paymentElement = null;
    var clientSecret = null;
    var registrationId = null;

    // Initialize Stripe only if key is available
    document.addEventListener('DOMContentLoaded', function() {
        // Temporary hardcoded key for testing
        const stripeKey = 'pk_test_51SVIpEPYEj8hTUzF27uSE7odPYyGdwqqw0H16Oo2zcWvok6SdTXGP8TShnpAjhaBq9qm4M8JTVthuayRzug9O0nc006H1zBCYV';
        console.log('Stripe key loaded:', stripeKey ? 'LOADED' : 'EMPTY');
        console.log('Stripe library available:', typeof Stripe !== 'undefined');

        if (stripeKey && stripeKey.trim() !== '' && typeof Stripe !== 'undefined') {
            try {
                stripe = Stripe(stripeKey);
                console.log('Stripe initialized successfully');
            } catch (error) {
                console.error('Stripe initialization error:', error);
            }
        } else {
            console.warn('Stripe publishable key not configured or Stripe library not loaded');
        }
    });

    function selectPlan(planName, price) {
        selectedPlan = planName;
        selectedPrice = price;

        // Update visual selection
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('selected');
            const btn = card.querySelector('.btn-plan-select');
            if (btn) btn.classList.remove('selected');
        });

        const selectedCard = document.getElementById('plan-' + planName);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            const selectedBtn = selectedCard.querySelector('.btn-plan-select');
            if (selectedBtn) selectedBtn.classList.add('selected');
        }

        // Show payment form with animation
        showPaymentSection();

        console.log('Plan selected:', planName, price);
    }



    async function showPaymentSection() {
        if (!stripe) {
            alert('Error: Configuraci√≥n de pagos no disponible');
            return;
        }

        // Create registration record first
        try {
            const response = await fetch('/api/suscripcion/registrar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    selected_plan: selectedPlan,
                    admin_first_name: 'Temp',
                    admin_last_name: 'User',
                    contact_email: 'temp@example.com',
                    contact_phone: '1234567890'
                })
            });

            const result = await response.json();

            if (result.success) {
                registrationId = result.registration_id;
            } else {
                alert('Error: ' + result.error);
                return;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n. Int√©ntalo de nuevo.');
            return;
        }

        // Show payment form after plan selection
        document.getElementById('payment-section').classList.remove('hidden');

        // Update plan summary
        const planName = selectedPlan === 'estandar' ? 'Est√°ndar' : 'Pro';
        document.getElementById('plan-summary').innerHTML = `
            <div class="flex justify-between items-center">
                <span style="color: var(--text-primary); font-weight: 600;">Plan ${planName}</span>
                <span style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;">$${selectedPrice}/mes</span>
            </div>
        `;

        // Setup Stripe payment
        try {
            const paymentResponse = await fetch('/api/suscripcion/pago/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    registration_id: registrationId,
                    payment_method: 'stripe'
                })
            });

            const paymentResult = await paymentResponse.json();

            if (paymentResult.success) {
                clientSecret = paymentResult.client_secret;

                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'night',
                        variables: {
                            colorPrimary: '#00d4ff',
                            colorBackground: '#1a1a1a',
                            colorText: '#ffffff',
                            colorDanger: '#ff4444',
                            borderRadius: '12px'
                        }
                    }
                });

                paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

            } else {
                alert('Error configurando pago: ' + paymentResult.error);
            }
        } catch (error) {
            console.error('Error setting up payment:', error);
            alert('Error configurando el pago. Int√©ntalo de nuevo.');
        }

        currentStep = 'payment';
    }

    function goBackToPlans() {
        document.getElementById('payment-section').classList.add('hidden');
        document.getElementById('business-section').classList.add('hidden');
        selectedPlan = null;
        currentStep = 'plan_selection';

        // Reset plan selection
        document.querySelectorAll('.plan-card').forEach(card => {
            card.classList.remove('border-blue-400', 'bg-blue-900/20');
            card.classList.add('border-gray-600');
        });
    }

    // Handle payment form submission
    document.getElementById('payment-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!stripe || !elements) {
            alert('Error: Sistema de pagos no disponible');
            return;
        }

        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        submitButton.disabled = true;
        buttonText.classList.add('hidden');
        spinner.classList.remove('hidden');

        try {
            // Get user info from form
            const userName = document.getElementById('user-name').value;
            const userEmail = document.getElementById('user-email').value;
            const userPhone = document.getElementById('user-phone').value;

            const {error, paymentIntent} = await stripe.confirmPayment({
                elements,
                redirect: 'if_required',
                confirmParams: {
                    payment_method_data: {
                        billing_details: {
                            name: userName,
                            email: userEmail,
                            phone: userPhone,
                        }
                    }
                },
            });

            if (error) {
                console.error('Payment error:', error);
                alert('Error en el pago: ' + error.message);

                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                // Payment successful - show business form
                console.log('Payment successful:', paymentIntent);
                showBusinessForm();
            } else {
                alert('El pago est√° siendo procesado...');
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        } catch (error) {
            console.error('Payment processing error:', error);
            alert('Error procesando el pago. Int√©ntalo de nuevo.');

            submitButton.disabled = false;
            buttonText.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
    });

    // Show business form after successful payment
    function showBusinessForm() {
        document.getElementById('payment-section').classList.add('hidden');
        document.getElementById('business-section').classList.remove('hidden');
        currentStep = 'business';

        // Scroll to business form
        document.getElementById('business-section').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // Handle business form submission
    document.getElementById('business-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitButton = document.getElementById('submit-business');
        const buttonText = submitButton.querySelector('span');
        submitButton.disabled = true;
        buttonText.textContent = 'Completando registro...';

        try {
            // Get business info from form
            const businessData = {
                business_name: document.getElementById('business-name').value,
                business_type: document.getElementById('business-type').value,
                rfc: document.getElementById('rfc').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postal_code: document.getElementById('postal-code').value,
                registration_id: registrationId
            };

            // Send business data to backend
            const response = await fetch('/api/suscripcion/completar-negocio/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(businessData)
            });

            const result = await response.json();

            if (result.success) {
                // Registration complete - redirect to success page
                window.location.href = '/suscripcion/confirmada/';
            } else {
                alert('Error completando el registro: ' + (result.error || 'Error desconocido'));
                submitButton.disabled = false;
                buttonText.textContent = 'Completar Registro';
            }
        } catch (error) {
            console.error('Business registration error:', error);
            alert('Error completando el registro. Int√©ntalo de nuevo.');
            submitButton.disabled = false;
            buttonText.textContent = 'Completar Registro';
        }
    });

    // Helper function to get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}